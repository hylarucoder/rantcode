---
title: 优化 docs 文件监听性能与行为
status: backlog
priority: P2
owner: AI
---

# 优化 docs 文件监听性能与行为

## 背景

当前应用通过 `chokidar` 监听 `agent-docs` 目录的文件变化，并通过 `notifyBridge` 将事件推送到 renderer。核心逻辑位于：

- `src/main/docsWatcher.ts`
- `src/main/notifyBridge.ts`

在一般规模的文档目录下工作正常，但随着文档数量增多、保存频率提高，存在潜在的性能与体验问题，例如：

- 监听范围较大，包含了很多非文档文件
- 每次变更都会在主进程中读取完整文件内容
- 高频保存时会产生大量重复的变更事件
- watcher 的创建与销毁在某些操作模式下可能较为频繁

本任务旨在在不改变对前端暴露的总体能力的前提下，优化 docs 文件监听的性能与行为。

## 目标

- **性能**：在文档数量较多、频繁保存的场景下，降低主进程 CPU 与 I/O 压力
- **稳定性**：减少不必要的 watcher 重建，提升长期运行的稳定性
- **可控性**：通过更明确的监听范围和简单的策略，避免被大文件或无关文件拖垮
- **可观测性（可选）**：对关键错误增加日志，便于排查真实环境问题

## 范围

在以下文件中进行改动（或新增辅助模块）：

- `src/main/docsWatcher.ts`
- （可选）`src/main/services/loggerService.ts` 及相关日志调用

前端 oRPC 合约与 `DocsWatcherEvent` 类型保持兼容，仅在事件频率与是否内联内容方面做策略优化。

## 需求拆分

### 1. 收窄监听范围

- **只监听真正需要的文档类型**  
  - 在 docs watcher 中为文件扩展名添加白名单（例如：`.md`、`.mdx`、`.markdown`、`.json`，具体视当前产品实际使用而定）
  - 在 `add` / `change` / `unlink` 回调中，对非白名单后缀的文件直接忽略，不向前端广播事件
- **合理调整 depth**  
  - 评估 `agent-docs` 目录的实际层级深度，将 `chokidar` 的 `depth` 从较大的默认值（目前为 `12`）调整为更合理的值（如 `4~6`），避免无意义的深层遍历

### 2. 降低主进程 I/O 压力

- **基线策略**  
  - 引入一个 `MAX_INLINE_SIZE`（例如 `512KB`），当文件体积超过该阈值时：
    - `DocsWatcherEvent` 中的 `content` 字段置为 `undefined`（或增加一个标记，表示为大文件）
    - 避免在主进程一次性读取大文件内容
- **可选增强（按需加载内容）**  
  - 如果前端不依赖 watcher 事件中的 `content`，可以将 docs watcher 改为只下发元信息（`path`、`changeType`、`updatedAt` 等），
    由前端在需要时通过单独的 oRPC 调用（如 `docs.readFile(path)`）来获取文件内容
  - 该改动需要与前端代码联动，确保 UI 行为不变或变更可控

### 3. 对高频写入做去抖（debounce）

- 针对同一路径的高频 `add` / `change` 事件：
  - 使用 `Map<string, NodeJS.Timeout>` 按 `filePath` 记录 pending 的定时器
  - 每次监听到变更事件时，重置该文件路径对应的定时器，在例如 `200~300ms` 后再真正调用 `emitFileEvent`
  - 对于 `unlink` 事件，可以选择不做去抖（尽量实时），或较短的 debounce
- 目标是让用户最终感知到的是“最终一次状态”，而不是短时间内的多个中间状态，同时减少不必要的 `readFile` 与前端 render

### 4. watcher 生命周期优化（可选）

- 当前逻辑：当某个项目 key 下的 `subscribers.size === 0` 时，会立即 `close()` 并移除对应的 watcher
- 优化建议：
  - 引入一个简单的 TTL（例如 `30 秒`）：
    - 当最后一个订阅移除时，不立即关闭 watcher，而是启动一个延迟关闭的定时器
    - 如果在 TTL 内该项目又有新的订阅加入，则取消关闭定时器，复用现有 watcher
  - 这样可以减少在“频繁打开/关闭 docs 面板”的使用模式下的 watcher 重建开销

### 5. 错误处理与日志增强（可选）

- 在 `watcher.on('error')` 与 `emitFileEvent` 的错误分支中：
  - 保留现有的 `DocsWatcherEvent` 错误广播，保证前端能够收到错误信息
  - 同时调用主进程 logger（如 `loggerService`）记录错误详情（包括 projectKey / baseDir / 具体错误信息），便于问题追踪
- 对于可预期且无害的错误（例如短时间内文件被删除导致的 `stat` 失败），可在前端选择静默处理

## 验收标准

- 在包含较多 docs 文件（> 1k）且频繁保存的项目中：
  - 主进程 CPU 占用相较于优化前有明显下降（定性观察即可，无需严格量化）
  - 不会因为单个大文件或二进制文件导致 watcher 阻塞或 UI 明显卡顿
- 在以下场景中，前端行为正确且体验良好：
  - 新建文档、修改文档、删除文档，文件树与内容展示同步更新
  - 高频保存同一个文档时，前端最终展示的是最新一次保存内容，没有明显的抖动或多次闪烁
  - 频繁切换 docs 面板 / 工作区视图，不会导致异常报错或监听彻底失效
- 错误场景：
  - 将 `agent-docs` 目录删除或移动后，前端可以收到合理的错误提示（或静默失败，视产品设计而定），主进程日志中有对应记录

## 后续扩展（非本次任务必做）

- 为 docs watcher 增加简单的统计信息（如当前监听文件数、最近一分钟变更次数），用于后续在开发者工具或诊断界面中展示
- 根据真实使用情况，进一步调优：
  - 白名单扩展名列表
  - `MAX_INLINE_SIZE` 阈值
  - debounce 时间窗口
  - watcher TTL 时长


