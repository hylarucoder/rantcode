# 国际化（i18n）设计与接入说明

本文档描述 Rantcode 的国际化（i18n）方案，支持中文（zh-CN）和英文（en-US）界面切换。

## 目标与范围

- 支持界面语言切换：中文（简体）/ English
- 与现有 Settings 的语言配置联动（`generalSettings.language`）
- 翻译覆盖所有用户可见的静态文本
- 保持类型安全，IDE 可提示翻译 key

## 技术选型

### 核心依赖

| 库 | 版本 | 说明 |
|----|------|------|
| `i18next` | ^24.x | 国际化核心框架 |
| `react-i18next` | ^16.3.5 | React 绑定 |

### 选型理由

- React 生态最成熟的 i18n 方案
- 支持 namespace 拆分、按需加载
- 完善的 TypeScript 类型推导
- 插值、复数、上下文等功能完备
- 社区活跃，文档齐全

## 架构设计

### 目录结构

```
src/renderer/src/
├── lib/
│   └── i18n.ts                 # i18n 初始化配置
├── locales/
│   ├── zh-CN.json              # 中文翻译
│   └── en-US.json              # 英文翻译
├── types/
│   └── i18n.d.ts               # 类型声明（可选）
```

### 翻译 key 组织

翻译 key 按模块前缀组织，统一放在单个 JSON 文件中：

| 前缀 | 覆盖范围 |
|------|----------|
| `common.*` | 通用按钮、状态词、确认/取消等 |
| `projects.*` | 项目列表页、添加/删除项目 |
| `workspace.*` | 工作区、会话、消息、面板 |
| `settings.*` | 设置页面所有分类 |
| `errors.*` | 错误提示、Toast 消息 |

## 配置与初始化

### i18n.ts 配置

```ts
import i18n from 'i18next'
import { initReactI18next } from 'react-i18next'

// 静态导入翻译资源
import zhCN from '@/locales/zh-CN.json'
import enUS from '@/locales/en-US.json'

export const supportedLngs = ['zh-CN', 'en-US'] as const
export type SupportedLng = (typeof supportedLngs)[number]

i18n.use(initReactI18next).init({
  resources: {
    'zh-CN': { translation: zhCN },
    'en-US': { translation: enUS },
  },
  lng: localStorage.getItem('language') || 'zh-CN',
  fallbackLng: 'en-US',
  interpolation: {
    escapeValue: false, // React 已自动转义
  },
})

export default i18n
```

### 与 Settings 联动

```ts
// 在 App.tsx 或专门的 Provider 中
import { useEffect } from 'react'
import { useTranslation } from 'react-i18next'
import { useGeneralSettingsQuery } from '@/features/settings/api/generalHooks'

export function useLanguageSync() {
  const { i18n } = useTranslation()
  const { data: settings } = useGeneralSettingsQuery()

  useEffect(() => {
    if (settings?.language && settings.language !== i18n.language) {
      i18n.changeLanguage(settings.language)
    }
  }, [settings?.language, i18n])
}
```

## 翻译文件格式

### zh-CN.json 示例

```json
{
  "common": {
    "button": {
      "ok": "确定",
      "cancel": "取消",
      "save": "保存",
      "delete": "删除",
      "add": "添加",
      "edit": "编辑",
      "close": "关闭",
      "refresh": "刷新",
      "back": "返回"
    },
    "status": {
      "loading": "加载中…",
      "saving": "保存中…",
      "success": "成功",
      "failed": "失败",
      "active": "活跃"
    }
  },
  "projects": {
    "title": "项目",
    "empty": "暂无项目",
    "emptyHint": "选择现有工作区或添加本地仓库开始工作",
    "add": {
      "title": "添加项目",
      "button": "新建项目",
      "firstProject": "添加第一个项目",
      "name": "名称",
      "namePlaceholder": "My repo",
      "nameHint": "可选的显示名称",
      "path": "仓库路径",
      "pathPlaceholder": "/Users/me/Projects/my-repo",
      "pathError": "请输入仓库的绝对路径",
      "browse": "浏览…",
      "browsing": "选择中…",
      "adding": "添加中…"
    },
    "remove": {
      "button": "移除",
      "confirm": "确定从 rantcode 移除 {{name}} 吗？文件将保留在磁盘上。",
      "success": "项目已移除"
    },
    "open": "打开",
    "loadingProjects": "加载项目中…"
  },
  "workspace": {
    "session": {
      "title": "会话",
      "new": "新建",
      "messageCount": "{{count}} 条消息"
    }
  },
  "settings": {
    "title": "设置",
    "general": "通用",
    "agents": "代理",
    "sounds": "音效"
  },
  "errors": {
    "unknown": "发生未知错误",
    "networkError": "网络连接失败"
  }
}
```

### 插值

```json
{
  "projects": {
    "remove": {
      "confirm": "确定从 rantcode 移除 {{name}} 吗？文件将保留在磁盘上。"
    }
  },
  "task": {
    "duration": "用时 {{seconds}} 秒",
    "exitCode": "退出码 {{code}}"
  }
}
```

## 组件中使用

### 基础用法

```tsx
import { useTranslation } from 'react-i18next'

function ProjectsPage() {
  const { t } = useTranslation()

  return (
    <div>
      <h1>{t('projects.title')}</h1>
      <p>{t('projects.emptyHint')}</p>
      <Button>{t('projects.add.button')}</Button>
    </div>
  )
}
```

### 混合模块使用

```tsx
function MyComponent() {
  const { t } = useTranslation()

  return (
    <Dialog>
      <DialogTitle>{t('projects.add.title')}</DialogTitle>
      <DialogFooter>
        <Button>{t('common.button.cancel')}</Button>
        <Button>{t('common.button.ok')}</Button>
      </DialogFooter>
    </Dialog>
  )
}
```

### 插值

```tsx
// 简单插值
t('projects.remove.confirm', { name: project.name })
// => "确定从 rantcode 移除 My Project 吗？文件将保留在磁盘上。"

// 带变量
t('task.duration', { seconds: 12.5 })
// => "用时 12.5 秒"
```

## 类型安全（可选增强）

### 类型声明文件

```ts
// src/renderer/src/types/i18n.d.ts
import 'i18next'
import type zhCN from '@/locales/zh-CN.json'

declare module 'i18next' {
  interface CustomTypeOptions {
    resources: {
      translation: typeof zhCN
    }
  }
}
```

启用后，`t('invalid.key')` 会有 TypeScript 编译错误提示。

## 需要翻译的模块清单

### 布局层

| 文件 | 需翻译内容 |
|------|-----------|
| `AppShell.tsx` | Projects, Active, No projects, Select project, Add or manage projects, Remove current project, Open settings, Toggle theme |
| `StatusBar.tsx` | 状态栏文本 |

### 项目管理

| 文件 | 需翻译内容 |
|------|-----------|
| `ProjectsPage.tsx` | 页面标题、空状态、表单标签、按钮、错误提示 |

### 工作区

| 文件 | 需翻译内容 |
|------|-----------|
| `SessionList.tsx` | 会话、新建 |
| `Composer.tsx` | 输入框 placeholder、发送按钮 |
| `KanbanPanel.tsx` | 看板相关文本 |
| `GitPanel.tsx` | Git 相关文本 |
| `ProjectSettingsPanel.tsx` | 项目设置 |

### 设置页

| 文件 | 需翻译内容 |
|------|-----------|
| `SettingsPage.tsx` | 分类标签、描述、表单字段 |
| `SingleClaudeVendor.tsx` | Agent 配置表单 |
| `AudioFxSettings.tsx` | 音效设置 |
| `SfxSettings.tsx` | UI 音效设置 |
| `TTSSettings.tsx` | TTS 设置 |

### 通用组件

| 文件 | 需翻译内容 |
|------|-----------|
| `NotFound.tsx` | 404 页面文本 |
| 各种 Toast 消息 | 成功/失败提示 |
| 确认对话框 | confirm() 消息 |

## 迁移策略

### 渐进式迁移

1. **不破坏现有功能**：先搭建基础设施，逐步替换
2. **按模块迁移**：每次迁移一个模块，确保测试通过
3. **保留 fallback**：未翻译的 key 显示原始 key，便于发现遗漏

### 迁移检查清单

- [ ] 硬编码字符串 → `t('key')`
- [ ] 动态拼接 → 使用插值 `t('key', { var })`
- [ ] `confirm()` 消息 → 使用翻译后的文本
- [ ] Toast 消息 → 使用翻译后的文本
- [ ] aria-label / placeholder → 使用翻译

## 测试与验证

### 手动测试

1. 切换语言设置，验证界面即时更新
2. 刷新页面，验证语言设置持久化
3. 检查所有页面是否有遗漏的硬编码文本

### 自动化检测（可选）

- ESLint 插件：`eslint-plugin-i18next` 检测未翻译的字符串
- 脚本扫描：检查 `.tsx` 文件中的中/英文字符串

## 与现有功能的关系

- **Settings 语言配置**：直接复用 `generalSettings.language`，i18n 监听变化自动切换
- **localStorage**：作为 i18n 初始化时的 fallback 来源
- **不影响**：oRPC、数据库、文件系统等后端逻辑

